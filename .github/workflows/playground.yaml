name: playground

on:
  push:
    branches:
      - master
      - deploy*
    paths:
      - .github/workflows/playground.yaml
      - packages/**

# env:
#   APP_NAME: webchat-samples-uploadazurestorage
#   DOCKER_IMAGE: webchatsamples.azurecr.io/webchat-samples-uploadazurestorage
#   DOCKER_REGISTRY: webchatsamples.azurecr.io
#   DOCKER_TAG: sha-${{ github.sha }}
#   DOCKERFILE_PATH: samples/07.advanced-web-chat-apps/a.upload-to-azure-storage
#   PUBLISH_PROFILE: ${{ secrets.SAMPLES_UPLOADAZURESTORAGE_PUBLISH_PROFILE }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checking out for ${{ github.ref }}
        uses: actions/checkout@v2

      - run: |
          npm ci
          npm run bootstrap

      - run: |
          npm run build
          cd packages/playground
          npm run build
          cd build
          npm install serve@11.3.2
          zip -1rq ../zipdeploy.zip .
        env:
          NODE_ENV: production

      - uses: actions/upload-artifact@v2
        with:
          name: build
          path: packages/playground/zipdeploy.zip

      - id: deploy
        uses: azure/webapps-deploy@v2.1
        with:
          app-name: webchat-playground2
          slot-name: production
          publish-profile: ${{ secrets.PLAYGROUND_PUBLISH_PROFILE }}
          package: packages/playground/zipdeploy.zip

      - name: Ping deployment
        run: |
          sleep 5
          curl -s ${{ steps.deploy.outputs.webapp-url }}
