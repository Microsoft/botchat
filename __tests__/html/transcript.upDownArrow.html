<!DOCTYPE html>
<html lang="en-US">
  <head>
    <script crossorigin="anonymous" src="/__dist__/testharness.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
    <style type="text/css">
      .content-editable-placeholder::before {
        content: '<div contenteditable={true}>';
      }
    </style>
  </head>
  <body>
    <div id="webchat"></div>
    <script type="text/babel" data-presets="env,stage-3,react">
      const {
        ReactTestUtils: { Simulate },
        WebChatTest: {
          conditions,
          createDirectLineWithTranscript,
          createStore,
          elements,
          expect,
          host,
          pageObjects,
          timeouts,
          token
        }
      } = window;

      async function expectScroll(element, eventInitDict, shouldScroll) {
        const scrollable = elements.transcriptScrollable();

        const scrollTopAtBottommost = scrollable.scrollHeight - scrollable.offsetHeight;

        scrollable.scrollTop = scrollTopAtBottommost;

        Simulate.keyDown(element, eventInitDict);

        // "scrollTop" may not move immediately, but probably within the next 500 ms.
        await new Promise(resolve => setTimeout(resolve, 500));

        if (shouldScroll) {
          expect(scrollable.scrollTop).toBeLessThan(scrollTopAtBottommost, `Should scroll for ${element.outerHTML}`);
        } else {
          expect(scrollable.scrollTop).toBe(scrollTopAtBottommost, `Should not scroll for ${element.outerHTML}`);
        }
      }

      const NULL_FN = () => {};

      (async function () {
        const res = await fetch('assets/transcripts/markdown-message.json');

        if (!res.ok) {
          throw new Error(`Server returned ${res.status} while fetching transcript`);
        }

        const activityMiddleware = () => next => (...args) => {
          const [{ activity }] = args;

          if (activity.type === 'test-input') {
            return (
              <div>
                <section className="elements-should-scroll">
                  <h1>Elements here should scroll on arrow up/down</h1>
                  <article>
                    <input placeholder={'<input type="text" />'} type="text" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="button" value={'<input type="button">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="checkbox" value={'<input type="checkbox">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="file" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="image" value={'<input type="image">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="radio" value={'<input type="radio">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="reset" value={'<input type="reset">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="submit" value={'<input type="submit">'} />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="email">'} type="email" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="password">'} type="password" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="search">'} type="search" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="tel">'} type="tel" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="text">'} type="text" />
                  </article>
                  <article>
                    <input onChange={NULL_FN} placeholder={'<input type="url">'} type="url" />
                  </article>
                  <article>
                    <textarea placeholder={'<textarea>'} />
                  </article>
                  <article>
                    <div
                      className="content-editable-placeholder"
                      contentEditable={true}
                      suppressContentEditableWarning={true}
                    />
                  </article>
                  <article>
                    <div tabIndex={0}>{'<div tabIndex={0}>'}</div>
                  </article>
                  <article>
                    <input
                      autoComplete="off"
                      onChange={NULL_FN}
                      placeholder={'<input autoComplete="off" type="text">'}
                      type="text"
                    />
                  </article>
                </section>
                <section className="elements-should-not-scroll">
                  <h1>Elements here should NOT scroll on arrow up/down</h1>
                  <article>
                    <input
                      autoComplete="on"
                      onChange={NULL_FN}
                      placeholder={'<input autoComplete="on" type="text">'}
                      type="text"
                    />
                  </article>
                  <article>
                    <input onChange={NULL_FN} type="text" value={'<input type="text" value="...">'} />
                  </article>
                  <article>
                    <input placeholder={'<input type="number">'} type="number" />
                  </article>
                  <article>
                    <select>
                      <option>{'<select>'}</option>
                    </select>
                  </article>
                  <article>
                    <textarea defaultValue={'<textarea>'} />
                  </article>
                  <article>
                    <div contentEditable={true} suppressContentEditableWarning={true}>
                      {'<div contentEditable={true}>Something</div>'}
                    </div>
                  </article>
                </section>
                <section className="elements-should-scroll-with-alt-key">
                  <h1>Elements here should scroll on ALT + arrow up/down</h1>
                  <article>
                    <input onChange={NULL_FN} type="text" value={'<input type="text" value="...">'} />
                  </article>
                  <article>
                    <textarea defaultValue={'<textarea>'} />
                  </article>
                </section>
              </div>
            );
          }

          return next(...args);
        };

        const transcript = await res.json();

        window.WebChat.renderWebChat(
          {
            activityMiddleware,
            directLine: createDirectLineWithTranscript([
              ...transcript,
              {
                from: { role: 'bot' },
                id: '2.0',
                type: 'test-input'
              }
            ]),
            store: createStore()
          },
          document.getElementById('webchat')
        );

        await pageObjects.wait(conditions.uiConnected(), timeouts.directLine);
        await pageObjects.wait(conditions.scrollStabilized(), timeouts.scrollToBottom);

        // When the send box is empty, it should scroll.
        await expectScroll(elements.sendBoxTextBox(), { key: 'ArrowUp' }, true);

        // After setting the send box, it should not scroll.
        await pageObjects.typeInSendBox('Hello, World');
        await expectScroll(elements.sendBoxTextBox(), { key: 'ArrowUp' }, false);

        // Even the send box has content, it should scroll when pressing up arrow key on transcript.
        await expectScroll(elements.transcriptScrollable(), { key: 'ArrowUp' }, true);

        for (let element of document.querySelectorAll('.elements-should-scroll article > *')) {
          await expectScroll(element, { key: 'ArrowUp' }, true);
        }

        for (let element of document.querySelectorAll('.elements-should-not-scroll article > *')) {
          await expectScroll(element, { key: 'ArrowUp' }, false);
        }

        for (let element of document.querySelectorAll('.elements-should-scroll-with-alt-key article > *')) {
          await expectScroll(element, { key: 'ArrowUp' }, false);
          await expectScroll(element, { altKey: true, key: 'ArrowUp' }, true);
        }

        await host.done();
      })().catch(async err => {
        console.error(err);

        await host.error(err);
      });
    </script>
  </body>
</html>
